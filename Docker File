# Multi-stage build for Distributed Control System
FROM ubuntu:22.04 as builder

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV CC=gcc-11
ENV CXX=g++-11

# Install build dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    gcc-11 \
    g++-11 \
    libboost-all-dev \
    libgtest-dev \
    libgmock-dev \
    git \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy source code
COPY CMakeLists.txt ./
COPY src/ ./src/
COPY include/ ./include/
COPY tests/ ./tests/
COPY examples/ ./examples/

# Build the project
RUN mkdir build && cd build && \
    cmake .. \
        -DCMAKE_BUILD_TYPE=Release \
        -DBUILD_TESTS=ON \
        -DBUILD_EXAMPLES=ON \
        -DCMAKE_INSTALL_PREFIX=/usr/local && \
    make -j$(nproc) && \
    make test && \
    make install

# Runtime stage
FROM ubuntu:22.04

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    libboost-system1.74.0 \
    libboost-thread1.74.0 \
    libboost-chrono1.74.0 \
    libstdc++6 \
    && rm -rf /var/lib/apt/lists/*

# Copy built artifacts from builder
COPY --from=builder /usr/local/lib/libdcs.so* /usr/local/lib/
COPY --from=builder /usr/local/include/dcs /usr/local/include/dcs
COPY --from=builder /app/build/examples/ /opt/dcs/examples/

# Create non-root user
RUN useradd -ms /bin/bash dcs
USER dcs
WORKDIR /home/dcs

# Set library path
ENV LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH

# Entry point for running examples
ENTRYPOINT ["/bin/bash"]

# Default command shows available examples
CMD ["-c", "echo 'Available examples:' && ls /opt/dcs/examples/ && echo '\nRun with: /opt/dcs/examples/<example_name>'"]
